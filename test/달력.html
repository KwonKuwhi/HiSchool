<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Calendar</title>
  <link rel="stylesheet" href="./달력.css">
</head>

<body>
  <header class="header">
    <nav class="navbar">
      <div class="menu-icon">☰</div>
      <h1 class="logo">일정</h1>
      <div class="settings-icon">⚙</div>
    </nav>
  </header>

  <div class="sec_cal">
    <div class="cal_nav">
      <a href="javascript:;" class="nav-btn go-prev">prev</a>
      <div class="year-month"></div>
      <a href="javascript:;" class="nav-btn go-next">next</a>
    </div>
    <div class="cal_wrap">
      <div class="days">
        <div class="day">MON</div>
        <div class="day">TUE</div>
        <div class="day">WED</div>
        <div class="day">THU</div>
        <div class="day">FRI</div>
        <div class="day">SAT</div>
        <div class="day">SUN</div>
      </div>
      <div class="dates">
        <!-- 오늘 날짜의 일정 목록 -->
        <div class="current-date-schedules">
          <!-- 여기에 오늘 날짜의 일정 목록이 표시됩니다. -->
        </div>
      </div>

      <div class="schdules-box">
        <button id="openBtn" class="btn">일정보기</button>
        <div class="list-additional">
          <div class="list-additional-main"> </div>
        </div>
      </div>

      <button id="closeBtn" class="btn">닫기</button>
    </div>
  </div>

  <div class="fullscreen-modal">
    <div class="fullscreen-modal-content">
      <span class="close-fullscreen-modal">×</span>
      <div class="list">
        <div class="list-title">제목</div>
        <input type="text" class="dateInput-title" placeholder="제목을 입력하세요">
        <div class="list-content">내용</div>
        <input type="text" class="dateInput-content" placeholder="내용을 입력하세요">
      </div>
      <button id="submitDate">확인</button>
    </div>
  </div>

  <script>
    const fullscreenModal = document.querySelector('.fullscreen-modal');
    const fullscreenModelClose = document.querySelector('.close-fullscreen-modal');
    const dateInputTitle = document.querySelector('.dateInput-title');
    const dateInputContent = document.querySelector('.dateInput-content');
    const openBtn = document.getElementById('openBtn');
    const closeBtn = document.getElementById('closeBtn');
    const datesContainer = document.querySelector('.dates');
    const yearMonth = document.querySelector('.year-month');
    const goPrevBtn = document.querySelector('.go-prev');
    const goNextBtn = document.querySelector('.go-next');


    let thisMonth;
    let selectedDate;
    let schedules = [];

    // 모달을 숨기는 함수
    function hideFullscreenModal() {
      fullscreenModal.style.display = 'none';
      // 선택된 날짜 초기화
      selectedDate = null;
      // 이전/다음 버튼 클릭시 모든 스케줄 숨기기
      toggleSchedulesVisibility(null);
    }

    // X 버튼을 클릭할 때 모달 숨기기
    fullscreenModelClose.addEventListener('click', hideFullscreenModal);

    function toggleSchedulesBox(displayStyle) {
      const listAdditional = document.querySelector('.list-additional');
      listAdditional.style.display = displayStyle;
    }



    function openSchedulesBox() {
      toggleSchedulesBox('grid');
      closeBtn.style.display = 'block';
      openBtn.style.display = 'none';
    }



    function closeSchedulesBox() {
      toggleSchedulesBox('none');
      closeBtn.style.display = 'none';
      openBtn.style.display = 'block';
    }

    openBtn.addEventListener('click', openSchedulesBox);
    closeBtn.addEventListener('click', closeSchedulesBox);

    function addIconForDate(date) {
      const dayElem = document.querySelector(`.day[data-date="${date}"]`);
      if (dayElem) {
        const icon = dayElem.querySelector('.icon');
        if (!icon) {
          const icon = document.createElement('div');
          icon.className = 'icon';
          dayElem.appendChild(icon);
        }
      }
    }

    datesContainer.addEventListener('dblclick', function (e) {
      if (e.target.classList.contains('current')) {
        const clickedDate = e.target.textContent;
        fullscreenModal.style.display = 'flex';

        // 더블클릭 했을 때 아이콘 생성
        const selectedDateString = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${('0' + clickedDate).slice(-2)}`;
        addIconForDate(selectedDateString);
      }
    });

    // 팝업 모달창에서 x 눌렀을 때 아이콘을 숨기는 함수
    function hideIconOnModalClose() {
      // fullscreenModal.style.display = 'none'; 
      if (selectedDate) {
        const selectedDateString = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${('0' + selectedDate.textContent).slice(-2)}`;
        const hasSchedule = schedules.some(schedule => schedule.date === selectedDateString);

        if (!hasSchedule) {
          const dayElem = document.querySelector(`.day[data-date="${selectedDateString}"]`);
          const icon = dayElem.querySelector('.icon');

          if (icon) {
            icon.remove();
          }
        }
      }
    }


    // 클릭한 날짜에 해당하는 일정을 표시하고, 클릭하지 않은 날짜에 해당하는 일정을 숨기는 함수
    function toggleSchedulesVisibility(selectedDate) {
      const allDates = document.querySelectorAll('.day.current');
      allDates.forEach(dateElem => {
        const date = dateElem.getAttribute('data-date');
        const isSelectedDate = date === selectedDate;
        const hasSchedule = schedules.some(schedule => schedule.date === date);

        if (isSelectedDate) {
          dateElem.classList.add('selected');
        } else {
          dateElem.classList.remove('selected');
        }

        if (isSelectedDate || !hasSchedule) {
          updateIconForDate(date);
        }
      });
    }


    datesContainer.addEventListener('click', function (e) {
      if (e.target.classList.contains('current')) {
        const clickedDate = e.target.textContent;
        const clickedDateString = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${('0' + clickedDate).slice(-2)}`;
        addIconForDate(clickedDateString);

        if (selectedDate) {
          selectedDate.classList.remove('selected'); // 클릭 이전에 선택된 날짜의 'selected' 클래스를 제거합니다.
        }
        selectedDate = e.target;
        const selectedDateString = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${('0' + selectedDate.textContent).slice(-2)}`;
        toggleSchedulesVisibility(selectedDateString); // 클릭한 날짜에 대한 일정 표시/숨김 처리

        // 일정 목록을 업데이트하고 선택한 날짜의 일정만 표시
        updateScheduleList(selectedDateString);
      }
    });





    let scheduleIdCounter = 1;

    document.getElementById('submitDate').addEventListener('click', function () {
      const title = dateInputTitle.value;
      const content = dateInputContent.value;

      if (title && content) {
        const selectedDateString = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${('0' + selectedDate.textContent).slice(-2)}`;
        const schedule = { id: scheduleIdCounter++, date: selectedDateString, title, content };
        schedules.push(schedule);
        updateScheduleList(selectedDateString); // 일정을 추가한 날짜만 업데이트
        fullscreenModal.style.display = 'none';
        dateInputTitle.value = '';
        dateInputContent.value = '';
        selectedDate = null;

        // 일정을 추가할 때 아이콘 생성
        addIconForDate(selectedDateString);
      } else {
        alert('제목, 내용, 날짜를 모두 입력하세요.');

        // 일정을 취소할 때 아이콘 제거
        const selectedDateString = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${('0' + selectedDate.textContent).slice(-2)}`;
        removeIconFromCalendar(selectedDateString);
      }
    });

    // 아이콘 생성 추가 함수
    function displaySchedulesForSelectedDate(date) {
      const filteredSchedules = schedules.filter(schedule => schedule.date === date);
      updateScheduleList(filteredSchedules);
    }


    function updateScheduleList(selectedDate) {
      const currentDateSchedules = schedules.filter(schedule => schedule.date === selectedDate);

      const listAdditional = document.querySelector('.list-additional');
      listAdditional.innerHTML = '';

      // 정렬된 스케줄을 화면에 표시
      currentDateSchedules.forEach((schedule, index) => {
        let divMain = document.createElement('div');
        divMain.className = 'list-additional-main';

        let divTitle = document.createElement('div');
        divTitle.className = 'list-additional-title';
        divTitle.textContent = schedule.title;

        let divContent = document.createElement('div');
        divContent.className = 'list-additional-content';
        divContent.textContent = schedule.content;

        let divinfo = document.createElement('div');
        divinfo.className = 'additional-info';
        divinfo.textContent = schedule.date;

        let deleteButton = document.createElement('button');
        deleteButton.textContent = '삭제';
        deleteButton.className = 'delete-button'; // 클래스명 추가
        deleteButton.dataset.id = schedule.id; // 스케줄을 식별하는 ID를 데이터 속성으로 추가
        deleteButton.addEventListener('click', function () {
          deleteSchedule(schedule.id); // 해당 스케줄을 삭제
        });

        divMain.appendChild(divTitle);
        divMain.appendChild(divContent);
        divMain.appendChild(divinfo);
        divMain.appendChild(deleteButton);
        listAdditional.appendChild(divMain);
      });
    }

    function updateIconForDate(date) {
      const dayElem = document.querySelector(`.day[data-date="${date}"]`);
      if (dayElem) {
        const hasSchedule = schedules.some(schedule => schedule.date === date);
        const icon = dayElem.querySelector('.icon');

        if (hasSchedule && !icon) {
          const icon = document.createElement('div');
          icon.className = 'icon';
          dayElem.appendChild(icon);
        } else if (!hasSchedule && icon) {
          icon.remove();
        }
      }
    }


    // 스케줄 삭제 함수
    function deleteSchedule(id) {
      const index = schedules.findIndex(schedule => schedule.id === id);
      if (index !== -1) {
        schedules.splice(index, 1);
        updateScheduleList(selectedDate); // 스케줄이 삭제될 때 스케줄 목록 업데이트
      }
    }
    // 달력에서 아이콘을 제거하는 함수
    function removeIconFromCalendar(dateString) {
      const dayElem = document.querySelector(`.day[data-date="${dateString}"]`);
      if (dayElem) {
        const icon = dayElem.querySelector('.icon');
        if (icon) {
          icon.remove();
        }
      }
    }



    // 캘린더 초기화 함수 
    function calendarInit() {
      const date = new Date();
      const utc = date.getTime() + (date.getTimezoneOffset() * 60 * 1000);
      const kstGap = 9 * 60 * 60 * 1000;
      const today = new Date(utc + kstGap);

      // 수정된 부분: schedules 배열을 최근 추가한 순서대로 정렬
      schedules.sort(function (a, b) {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // dateB가 dateA보다 크면 내림차순
      });

      // 정렬된 배열을 사용하여 일정 목록을 업데이트 또는 표시
      updateScheduleList();

      thisMonth = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      // 이 코드를 추가하여 오늘 날짜의 일정을 필터링하고 업데이트합니다.
      const todayDateString = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${('0' + today.getDate()).slice(-2)}`;
      const todaySchedules = schedules.filter(schedule => schedule.date === todayDateString);
      updateScheduleList(todaySchedules);

      renderCalendar(thisMonth);

      function renderCalendar(thisMonth) {
        const startDay = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 0);
        const prevDate = startDay.getDate();
        const prevDay = startDay.getDay();

        const endDay = new Date(thisMonth.getFullYear(), thisMonth.getMonth() + 1, 0);
        const nextDate = endDay.getDate();
        const nextDay = endDay.getDay();

        yearMonth.textContent = `${thisMonth.getFullYear()}.${thisMonth.getMonth() + 1}`;

        const calendar = document.querySelector('.dates');
        calendar.innerHTML = '';

        // 이전 달 날짜를 렌더링
        for (let i = prevDate - prevDay + 1; i <= prevDate; i++) {
          calendar.innerHTML += `<div class="day prev disable">${i}</div>`;
        }

        // 이번 달 날짜를 렌더링 
        for (let i = 1; i <= nextDate; i++) {
          let formattedDay = ('0' + i).slice(-2);
          let formattedDate = `${thisMonth.getFullYear()}-${('0' + (thisMonth.getMonth() + 1)).slice(-2)}-${formattedDay}`;
          const dayElem = document.createElement('div');
          dayElem.className = 'day current';
          dayElem.textContent = i;
          dayElem.setAttribute('data-date', formattedDate);
          calendar.appendChild(dayElem);
        }

        // 다음 달 날짜를 렌더링
        for (let i = 1; i <= (7 - nextDay === 7 ? 0 : 7 - nextDay); i++) {
          calendar.innerHTML += `<div class="day next disable">${i}</div>`;
        }

        // 등록된 일정이 있는 날짜에 아이콘 생성
        schedules.forEach(schedule => {
          const dateElem = document.querySelector(`.day[data-date="${schedule.date}"]`);
          if (dateElem) {
            const icon = document.createElement('div');
            icon.className = 'icon';
            dateElem.appendChild(icon);
          }
        });

        // 오늘 날짜를 표시
        if (new Date().getMonth() === thisMonth.getMonth()) {
          const todayDate = new Date().getDate();
          const currentMonthDates = document.querySelectorAll('.dates .current');
          currentMonthDates[todayDate - 1].classList.add('today');
        }
      }
      goPrevBtn.addEventListener('click', function () {
        thisMonth.setMonth(thisMonth.getMonth() - 1);
        renderCalendar(thisMonth);
        selectedDate = null;
        // 이전/다음 버튼 클릭시 모든 스케줄 숨기기
        toggleSchedulesVisibility(null);
      });

      goNextBtn.addEventListener('click', function () {
        thisMonth.setMonth(thisMonth.getMonth() + 1);
        renderCalendar(thisMonth);
        selectedDate = null;
        // 이전/다음 버튼 클릭시 모든 스케줄 숨기기
        toggleSchedulesVisibility(null);
      });
    }

    calendarInit();

  </script>
</body>

</html>